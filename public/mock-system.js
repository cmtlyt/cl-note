!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).mockSystem={})}(this,(function(e){"use strict";function t(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var n=1e3,r=60*n,s=60*r,a=24*s,i=7*a,o=365.25*a;function c(e,t,n,r){var s=t>=1.5*n;return Math.round(e/n)+" "+r+(s?"s":"")}var u=t((function(e,t){t=t||{};var u=typeof e;if("string"===u&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!t)return;var c=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return c*o;case"weeks":case"week":case"w":return c*i;case"days":case"day":case"d":return c*a;case"hours":case"hour":case"hrs":case"hr":case"h":return c*s;case"minutes":case"minute":case"mins":case"min":case"m":return c*r;case"seconds":case"second":case"secs":case"sec":case"s":return c*n;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return c;default:return}}(e);if("number"===u&&isFinite(e))return t.long?function(e){var t=Math.abs(e);if(t>=a)return c(e,t,a,"day");if(t>=s)return c(e,t,s,"hour");if(t>=r)return c(e,t,r,"minute");if(t>=n)return c(e,t,n,"second");return e+" ms"}(e):function(e){var t=Math.abs(e);if(t>=a)return Math.round(e/a)+"d";if(t>=s)return Math.round(e/s)+"h";if(t>=r)return Math.round(e/r)+"m";if(t>=n)return Math.round(e/n)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}));function f(e){return btoa(encodeURIComponent(e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function d(e){const t=atob(e.replace(/-/g,"+").replace(/_/g,"/"));return decodeURIComponent(t)}function p(e){return(new TextEncoder).encode(e)}async function m(e,t){return f((n=await crypto.subtle.sign({name:"HMAC",hash:"SHA-256"},await crypto.subtle.importKey("raw",p(e),{name:"HMAC",hash:"SHA-256"},!1,["sign"]),p(t)),(new TextDecoder).decode(n)));var n}const y="zhihu-live-v1",l=location.origin,h=`${l}_${y}_ACCESS`,w=`${l}_${y}_REFRESH`,g=/((\d{11})|^((\d{7,8})|(\d{4}|\d{3})-(\d{7,8})|(\d{4}|\d{3})-(\d{7,8})-(\d{4}|\d{3}|\d{2}|\d{1})|(\d{7,8})-(\d{4}|\d{3}|\d{2}|\d{1}))$)/;function _(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}function b(e=16,t=""){const n=t+Math.random().toString(36).slice(2);return n.length>=e?n.slice(0,e):n+b(e-n.length,n)}function D(e){if("access"===e)return h;if("refresh"===e)return w;throw new Error("不存在该类型令牌")}async function v(e,t="access"){const n=D(t),r=await async function(e,t){try{const[n,r,s]=e.split("."),a=`${n}.${r}`;if(f(await m(t,a))!==s)return[!1,"Signature verification failed"];const i=JSON.parse(d(n)),o=Math.floor(Date.now()/1e3);return i.exp&&o>i.exp?[!1,"Token has expired"]:[!0,null,JSON.parse(d(r))]}catch(e){return[!1,e.message]}}(e,n);return r}async function S(e,t="access",n={}){const r=D(t);return await async function(e,t,n={}){var r;const s=f(JSON.stringify({alg:"HS256",typ:"JWT",exp:(r=n.expiresIn,"string"==typeof r?Math.floor(Date.now()/1e3)+Math.floor(u(r)/1e3):"number"==typeof r?Math.floor(Date.now()/1e3)+r:void 0)})),a=f(JSON.stringify(e)),i=`${s}.${a}`;return`${s}.${a}.${f(await m(t,i))}`}(e,r,n)}async function I(e){const t=await async function(e){return await S(e,"access",{expiresIn:"1d"})}(e),n=await async function(e){return await S(Object.assign({},{data:e},{isRefresh:!0}),"refresh",{expiresIn:"30d"})}(e);return{accessToken:t,refreshToken:n}}function k(e,t){if(!t)return!0;let n=0;return Array.isArray(t)?t.forEach((e=>n|=e)):n=t,(e&n)===n}function O(...e){return e.reduce(((e,t)=>e|t),0)}const $=new URL(l);let T=null;const M=new Map;function j(e){return new URL(`${$.href}${e}`)}async function E(e){const t=j(e);return M.get(t.href)||T.match(t).then((async e=>{if(e){const n=await e.json();let r=null;return"array"===_(n)&&(r={},n.forEach((e=>r[e.id]=e)),R(t.href,r)),M.set(t.href,r||n),n}return null}))}function x(e){return new Response(JSON.stringify(e))}async function R(e,t){const n=_(t);if(["object","array"].includes(n))return T.keys().then((async r=>{const s=j(e),a=r.find((e=>e.url===s.href));if(!a)return T.put(s,x(t));const i=await(await T.match(a)).json();if(_(i)===n)return;let o;return"object"===n?(o=Object.assign({},t),i.forEach((e=>o[e.id]=e))):o=[...t,...Object.keys(i).map((e=>i[e]))],T.put(s,x(o))}))}async function N(e,t){const n=await E(e)||{},[r,s,a]=P(e,t);if(!r)throw new Error(s||void 0);return n[a.id]=a,await T.put(j(e),x(n)),a}const J={get:async function(e){return E(e)},set:async function(e,t){return T.put(j(e),x(t))},insert:N,update:async function(e,t){const n=await E(e)||{},r=t.id;if(!r||!(r in n))return N(e,t);const[s,a,i]=P(e,t);if(!s)throw new Error(a);return n[r]=Object.assign(n[r],i),await T.put(j(e),x(n)),i},remove:async function(e,t){const n=await E(e)||{},r=t.id;if(r in n)return delete n[r],T.put(j(e),x(n))},clear:async function(e){return T.delete(j(e))},find:async function(e,t){const{id:n,matcher:r=(e=>e.id===n)}=t||{},s=await E(e),a=[];for(const e in s){const t=s[e];r(t)&&a.push(t)}return a},init:R,findById:async function(e,t){const n=await E(e)||{};return t in n?n[t]:null}};const{DB_SHOW_HIDDEN_FIELD:q}={DB_SHOW_HIDDEN_FIELD:1},C={type:"string",default:()=>b(16)},H={type:"boolean",default:()=>!1,permission:O(q)},A={type:"string",required:!0},B={type:"string",required:!0,permission:O(q)},L={type:"array",default:()=>[],permission:O(q)},U={createTime:{type:"date",default:()=>new Date,dtoTransForm:e=>e.toString()},updateTime:{type:"date",default:()=>new Date,permission:O(q),dtoTransform:e=>e.toString()}},F={user:{id:{...C,permission:O(q)},name:A,nickName:{type:"string"},password:{...B},age:{type:"number"},sex:{type:"string"},email:{type:"string"},phone:{type:"string",verify:e=>g.test(e)},permission:{type:"number",default:()=>0,permission:O(q)},avatar:{type:"string"},isDeleted:H,...U,groupIds:L},session:{id:C,info:A,expireTime:{type:"date",default:()=>new Date((new Date).getTime()+3e5)},...U},group:{id:C,name:A,ownerId:B,isDeleted:H,...U},groupUser:{id:C,groupId:B,userId:B,...U},groupBill:{id:C,groupId:B,billId:B,...U},bill:{id:C,type:A,title:A,amount:{type:"number",required:!0},date:{type:"date",required:!0},...U,userId:B,groupIds:L}};function P(e,t){const n=F[e];if(!n)return[!1,`未找到${e}表`];const r={},s=[];for(const e in n){const a=r[e]=t[e],i=n[e];if(i.required&&!a)return[!1,`缺少${e}字段`];if(i.default&&!a&&(r[e]=i.default()),i.required&&_(a)!==i.type)return[!1,`字段${e}类型错误, 期望${i.type}, 实际${_(a)}`];if(i.verify&&a&&!i.verify(a))return[!1,`字段${e}验证失败`];i.autoUpdate&&s.push(e)}for(const e of s)r[e]=n[e].default();return[!0,void 0,r]}function z(e,t,n){const r=F[e];if(!r)return t;const s={...t};for(const e in r){const t=r.alias||e;k(n,r[e].permission)?s[t]||(s[t]=(a=r[e].type,{string:"",number:0,boolean:!1,date:new Date,array:[],object:{}}[a])):delete s[e],r[e].dtoTransform&&(s[t]=r[e].dtoTransform(s[t]))}var a;return s}function W(e,t=!1){return async n=>{const{headers:r}=n,s=r.authorization,a=s?.split(" ")[1];if(!a){if(!t)return{__format:!0,status:401,data:{message:"未授权"}};const s=r.fingerprint;return s?e(Object.assign(n,{tokenData:{id:s,permission:0}})):{__format:!0,status:401,data:{message:"未授权"}}}const[i,o,c]=await v(a);return i?c.isRefresh?{__format:!0,status:401,data:{message:"refreshToken 无法认证"}}:e(Object.assign(n,{tokenData:c})):{__format:!0,status:401,data:{message:o}}}}const K={post:{async register({data:e}){const[t]=await J.find("user",{matcher:t=>t.name===e.name});if(t)return{__format:!0,status:400,data:{message:"用户名已存在"}};try{const t=await J.insert("user",e);return{success:!0,...await I({id:t.id,permission:t.permission})}}catch(e){return{__format:!0,status:500,data:{message:e.message}}}},async login({data:e}){const[t]=await J.find("user",{matcher:t=>t.name===e.name&&t.password===e.password});return t?{success:!0,...await I({id:t.id,permission:t.permission})}:{__format:!0,status:400,data:{message:"用户名或密码错误"}}},async checkCaptcha({data:e}){const{captcha:t,captchaId:n}=e;if(!t)return{__format:!0,status:400,data:{message:"验证码不能为空"}};if(!n)return{__format:!0,status:400,data:{message:"验证码ID不能为空"}};const r=await J.findById("session",n);if(!r)return{__format:!0,status:400,data:{message:"验证码不存在"}};if(r.expireTime<new Date)return await J.remove("session",r),{__format:!0,status:400,data:{message:"验证码已过期"}};return JSON.parse(r.info).captcha!==t?{__format:!0,status:400,data:{message:"验证码错误"}}:(await J.remove("session",r),{success:!0})},createBill:W((async({data:e,tokenData:t})=>({success:!0,data:{billId:(await J.insert("bill",{...e,date:new Date(e.date),userId:t.id})).id}})))},get:{async captcha({query:e}){if(!e.phone)return{__format:!0,status:400,data:{message:"手机号不能为空"}};const t=b(6);return{success:!0,captchaId:(await J.update("session",{id:b(16),info:JSON.stringify({phone:e.phone,captcha:t})})).id,captcha:t}},async refresh({query:e}){if(!e.refreshToken)return{__format:!0,status:400,data:{message:"refreshToken不能为空"}};const[t,n,r]=await v(e.refreshToken,"refresh");if(!t)return{__format:!0,status:401,data:{message:n}};const{isRefresh:s,data:a}=r;return s?{success:!0,...await I(a)}:{__format:!0,status:401,data:{message:"refreshToken无效"}}},test:W((async({tokenData:e})=>({success:!0,...e}))),getUserInfo:W((async({tokenData:e})=>{const{id:t}=e,n=await J.findById("user",t);return n?n.isDeleted?{__format:!0,status:400,data:{message:"用户已删除"}}:{success:!0,data:{userInfo:z("user",n,n.permission)}}:{__format:!0,status:400,data:{message:"用户不存在"}}})),bill:{list:W((async({query:e,tokenData:t})=>{const{id:n,permission:r}=t,{current:s,pageSize:a}=e;return{success:!0,bills:(await J.find("bill",{matcher:e=>e.userId===n})).slice((s-1)*a,s*a).map((e=>z("bill",e,r)))}}),!0)}}};function G(e,t=K){if(e in t)return t[e];const[n,r]=e.replace(".","\n").split("\n");if(!n)return;const s=t[n];return s?r?G(r,s):s:void 0}const Q=new Proxy({},{get:(e,t)=>G(t)});async function V(e,t){const n=G(e);if(!n)throw new Error(`未找到${e}控制器`);return n(t)}async function X(e,t,n){const r="get"===e?{}:await n.json(),s={},a={};return Array.from(n.headers.entries()).forEach((([e,t])=>a[e]=t)),t.searchParams.forEach(((e,t)=>s[t]=e)),{data:r,query:s,headers:a,$__call:V}}async function Y(e,t,n){try{const r=n.method.toLowerCase(),s=Q[function(e,t){return[e,...t.split("/")].filter(Boolean).join(".")}(r,e)];if(!s)return new Response(null,{status:404});return await async function(e){return"object"==typeof e&&"function"==typeof e.then&&(e=await e),e instanceof Response?e:"object"==typeof e&&e.__format?new Response(JSON.stringify(e.data),{status:e.status||200}):new Response(JSON.stringify({data:e,time:Date.now()}))}(s({uri:t,request:n,...await X(r,t,n)}))}catch(e){return new Response(JSON.stringify({error:e.message}),{status:500})}}async function Z(){await async function(){return caches.open(y).then((async e=>T=e))}(),await async function(){await Promise.all(Object.keys(F).map((e=>J.init(e,{}))))}()}var ee={getMockData:Y,initMockSystem:Z};e.default=ee,e.getMockData=Y,e.initMockSystem=Z,Object.defineProperty(e,"__esModule",{value:!0})}));
